<app-header></app-header>

<div class="container py-5">
  <h1 class="text-center mb-4 fw-bold">Detalles del Juego</h1>

  @if (juego) {
    <div class="card shadow border-0">
      <div class="card-header bg-primary text-white py-3">
        <div class="d-flex justify-content-between align-items-center">
          <span class="fs-5 fw-semibold">{{ juego.titulo }}</span>
          <span class="badge text-bg-light text-dark">
            {{ juego.clasificacion }}
          </span>
        </div>
      </div>

      <div class="card-body">
        <p class="text-muted mb-2">
          <strong>Empresa:</strong> {{ juego.nombreEmpresa }}
        </p>

        <p class="mb-3">
          <strong>Descripción:</strong><br />
          {{ juego.descripcion }}
        </p>

        <div class="row g-3">
          <div class="col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Fecha lanzamiento</div>
              <div class="fw-semibold">{{ juego.fechaLanzamiento }}</div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="border rounded p-3 h-100">
              <div class="text-muted small">Clasificación</div>
              <div class="fw-semibold">{{ juego.clasificacion }}</div>
            </div>
          </div>

          <div class="col-12">
            <div class="border rounded p-3">
              <div class="text-muted small">Recursos mínimos</div>
              <div class="fw-semibold">{{ juego.recursosMinimos }}</div>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <div class="border rounded p-3">
          <h5 class="fw-bold mb-3">Calificar y comentar</h5>

          <div class="mb-3">
            <div class="text-muted small mb-2">Tu calificación</div>

            <div class="d-flex align-items-center gap-2">
              <div class="btn-group" role="group" aria-label="Calificación">
                <button type="button" class="btn btn-outline-warning"
                        (click)="calificacion = 1" [class.active]="calificacion === 1">★</button>
                <button type="button" class="btn btn-outline-warning"
                        (click)="calificacion = 2" [class.active]="calificacion === 2">★★</button>
                <button type="button" class="btn btn-outline-warning"
                        (click)="calificacion = 3" [class.active]="calificacion === 3">★★★</button>
                <button type="button" class="btn btn-outline-warning"
                        (click)="calificacion = 4" [class.active]="calificacion === 4">★★★★</button>
                <button type="button" class="btn btn-outline-warning"
                        (click)="calificacion = 5" [class.active]="calificacion === 5">★★★★★</button>
              </div>

              <span class="text-muted" *ngIf="calificacion">({{ calificacion }}/5)</span>
            </div>
          </div>

          <div class="mb-3">
            <label for="comentario" class="form-label text-muted small">Tu comentario</label>
            <textarea
              id="comentario"
              class="form-control"
              rows="3"
              [(ngModel)]="comentario"
              placeholder="Escribe tu opinión del juego..."
            ></textarea>
          </div>

          <button class="btn btn-success w-100"
                  (click)="enviarComentario()"
                  [disabled]="!calificacion || !comentario || comentario.trim().length === 0">
            Enviar reseña
          </button>

          <small class="text-muted d-block mt-2">
            Debes seleccionar una calificación y escribir un comentario.
          </small>
        </div>

        <hr class="my-4" />

        <div class="border rounded p-3">
          <h5 class="fw-bold mb-3">Comentarios</h5>

          <div *ngIf="comentarios.length === 0" class="text-muted">
            Aún no hay comentarios.
          </div>

          <ng-container *ngFor="let c of comentarios">
            <ng-container
              *ngTemplateOutlet="comentarioTpl; context: { $implicit: c, nivel: 0 }">
            </ng-container>
          </ng-container>
        </div>

        <ng-template #comentarioTpl let-c let-nivel="nivel">
          <div class="border rounded p-3 mb-3"
               [style.marginLeft.px]="nivel * 22"
               [style.borderLeft]="nivel > 0 ? '3px solid #e9ecef' : ''">

            <div class="d-flex justify-content-between">
              <div class="fw-semibold">{{ c.idUsuario }} -- Estrellas: {{c.calificacion}}</div>
            </div>

            <div class="mt-2">{{ c.comentario }}</div>

            <div class="mt-3">
              <button class="btn btn-sm btn-outline-primary"
                      (click)="iniciarRespuesta(c.idComentario)">
                Responder
              </button>
            </div>

            <div class="mt-3" *ngIf="respondiendoA === c.idComentario">
              <textarea class="form-control" rows="2"
                        [(ngModel)]="respuesta"
                        placeholder="Escribe tu respuesta..."></textarea>

              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-success"
                        (click)="enviarRespuesta()"
                        [disabled]="!respuesta || respuesta.trim().length === 0">
                  Enviar
                </button>
                <button class="btn btn-sm btn-outline-secondary"
                        (click)="cancelarRespuesta()">
                  Cancelar
                </button>
              </div>
            </div>

            <div class="mt-3" *ngIf="c.respuestas && c.respuestas.length > 0">
              <ng-container *ngFor="let r of c.respuestas">
                <ng-container
                  *ngTemplateOutlet="comentarioTpl; context: { $implicit: r, nivel: nivel + 1 }">
                </ng-container>
              </ng-container>
            </div>

          </div>
        </ng-template>

      </div>
    </div>
  }
</div>
